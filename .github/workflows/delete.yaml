name: Delete All

on:
  workflow_dispatch:
      
jobs:
  delete-all:
     name: delete
     runs-on: ubuntu-latest
     steps:
    
     - name: Checkout
       uses: actions/checkout@v2
    
     - name: Setup AWS Credentials
       uses: aws-actions/configure-aws-credentials@v1
       with:
         aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
         aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
         aws-region: "eu-west-1"
      
     - name: Setup EB CLI
       uses: sparkplug-app/install-eb-cli-action@v1.0.0
       
     - name: Delete App
       working-directory: ./flask-pastebin
       run: |
            eb init -p python-3.8 flask-pastebin --region eu-west-1
            eb terminate --all --force
            
     - name: Delete S3 Bucket generated by Elastic BeanStalk
       run: |
            REGION=eu-west-1
            ACCOUNT_ID=$(aws sts get-caller-identity --output text --query 'Account')
            aws s3 rm s3://elasticbeanstalk-$REGION-$ACCOUNT_ID --recursive --region $REGION
            aws s3api delete-bucket-policy --bucket elasticbeanstalk-$REGION-$ACCOUNT_ID --region $REGION
            aws s3api delete-bucket --bucket elasticbeanstalk-$REGION-$ACCOUNT_ID --region $REGION

     - name: Delete S3 Backup
       run: |
            REGION=eu-west-1
            BACKUP_NAME=$(aws s3 ls | grep -o deadbycloud-.....)
            aws s3 rm s3://$BACKUP_NAME --recursive --region $REGION
            aws s3api delete-bucket --bucket $BACKUP_NAME --region $REGION
